<link rel="import" href="../g-cookies/g-cookies.html">

<polymer-element name="g-app-controller" attributes="sessionCookieName start">
	<template>
		<link rel="stylesheet" href="g-app-controller.css">
		<g-cookies id="cookies"></g-cookies>
		<div class="{{ !loggedIn ? 'show' : 'hide' }}">
			<content select="[whenNotLoggedIn]"></content>
		</div>
		<div class="{{ loggedIn ? 'show' : 'hide' }}">
			<content select="[whenLoggedIn]"></content>
		</div>
	</template>
	<script>
		Polymer('g-app-controller', {

			sessionCookie: null,

			loggedIn: false,

			logoff: function() {
				this.token    = null;
				this.loggedIn = false;
			},
			
			domReady: function() {
				console.log('[CONTROLLER] domReady');
				var cookie = this.$.cookies.getItem(this.sessionCookieName);
				var handler = function(reply) {
					if(reply.value)
					{
						this.onSessionVerified(cookie);
					}
				};
				this.testSession(cookie, handler.bind(this));
			},

			testSession: function() {
				throw 'Please override the testSession() function'; 
			},

			onSessionVerified: function(token) {
				this.$.cookies.setItem(this.sessionCookieName, token);
				this.sessionCookie = token;
				this.loggedIn = true;
				var router = this.querySelector('g-app-router');
				if(router)
				{
					router.init();
				}
			},
		});
	</script>
</polymer-element>
